import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split

# üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
plt.rcParams['font.size'] = 12
sns.set_style("whitegrid")


# ‚úÖ 1. –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–• –û–ë–£–ß–ê–Æ–©–ò–• –î–ê–ù–ù–´–•
def prepare_klient_data():
    klienty = []

    for i in range(5000):  # –±–æ–ª—å—à–æ–π –¥–∞—Ç–∞—Å–µ—Ç
        vozrast = np.random.randint(18, 70)
        pokupki = np.random.randint(0, 40)
        sredniy_chek = np.random.uniform(200, 30000)
        akcii = np.random.choice([0, 1])
        otsenka = np.random.uniform(1, 5)

        # ‚úÖ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
        prob = (
            0.30 * (pokupki / 40) +
            0.40 * (sredniy_chek / 30000) +
            0.20 * (otsenka / 5) +
            0.10 * akcii
        )

        # ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —à—É–º (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å)
        prob += np.random.normal(0, 0.08)

        # ‚úÖ –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
        prob = max(0, min(1, prob))

        # ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
        loyal = np.random.choice([1, 0], p=[prob, 1 - prob])

        klienty.append({
            "–í–æ–∑—Ä–∞—Å—Ç": vozrast,
            "–ü–æ–∫—É–ø–∫–∏": pokupki,
            "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)": sredniy_chek,
            "–ê–∫—Ü–∏–∏": akcii,
            "–û—Ü–µ–Ω–∫–∞": otsenka,
            "–õ–æ—è–ª—å–Ω—ã–π": loyal
        })

    return pd.DataFrame(klienty)


# ‚úÖ 2. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò
def create_visualizations(results, n_new):
    fig, axes = plt.subplots(1, 2, figsize=(12, 5))
    fig.suptitle(f"–ê–Ω–∞–ª–∏–∑ {n_new} –∫–ª–∏–µ–Ω—Ç–æ–≤", fontsize=16, weight='bold')

    # –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
    counts = results['–°—Ç–∞—Ç—É—Å'].value_counts()
    colors = ['#4CAF50' if s == '–õ–æ—è–ª—å–Ω—ã–π' else '#FF9800' for s in counts.index]
    axes[0].pie(counts.values, labels=counts.index, autopct='%1.1f%%',
                colors=colors, startangle=90)
    axes[0].set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤")

    # –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞
    axes[1].hist(results['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)'], bins=10, color='#2196F3', alpha=0.7, edgecolor='black')
    axes[1].axvline(results['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)'].mean(), color='red', linestyle='dashed')
    axes[1].set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞ (‚ÇΩ)")
    axes[1].set_xlabel("–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)")
    axes[1].set_ylabel("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤")

    plt.tight_layout()
    plt.show()


# ‚úÖ 3. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
def print_recommendations(results, n_new):
    risk_count = (results['–°—Ç–∞—Ç—É—Å'] == '–í –∑–æ–Ω–µ —Ä–∏—Å–∫–∞').sum()

    print(f"\nüìà –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
    print(f"–í—Å–µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {n_new} –∫–ª–∏–µ–Ω—Ç–æ–≤")
    print(f"–í –∑–æ–Ω–µ —Ä–∏—Å–∫–∞: {risk_count} ({risk_count/n_new:.1%})")

    print(f"\nüéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
    if risk_count == 0:
        print("‚úÖ –û—Ç–ª–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏! –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –ª–æ—è–ª—å–Ω—ã.")
        return

    print(f"‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ –∫ {risk_count} –∫–ª–∏–µ–Ω—Ç–∞–º:")
    risk_clients = results[results['–°—Ç–∞—Ç—É—Å'] == '–í –∑–æ–Ω–µ —Ä–∏—Å–∫–∞']

    for idx, client in risk_clients.iterrows():
        print(f"\n   üë§ –ö–ª–∏–µ–Ω—Ç {client['ID']}:")
        issues = []

        if client['–ü–æ–∫—É–ø–∫–∏'] < 3:
            issues.append("–º–∞–ª–æ –ø–æ–∫—É–ø–æ–∫")
        if client['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)'] < 2000:
            issues.append("–Ω–∏–∑–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫")
        if client['–û—Ü–µ–Ω–∫–∞'] < 3:
            issues.append("–Ω–∏–∑–∫–∞—è –æ—Ü–µ–Ω–∫–∞")

        if issues:
            print(f"      ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã: {', '.join(issues)}")
            print("      ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: —Å–∫–∏–¥–∫–∞ 5‚Äì10%, –±–æ–Ω—É—Å—ã, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ")
        else:
            print("      ‚Ä¢ –û–±—â–∞—è –Ω–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å")


# ‚úÖ 4. –û–°–ù–û–í–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê
print("üõçÔ∏è ML-–°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê –õ–û–Ø–õ–¨–ù–û–°–¢–ò –ö–õ–ò–ï–ù–¢–û–í (‚ÇΩ)")

data = prepare_klient_data()
print(f"üìä –û–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö: {len(data)} –∑–∞–ø–∏—Å–µ–π")

X = data[['–í–æ–∑—Ä–∞—Å—Ç', '–ü–æ–∫—É–ø–∫–∏', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)', '–ê–∫—Ü–∏–∏', '–û—Ü–µ–Ω–∫–∞']]
y = data['–õ–æ—è–ª—å–Ω—ã–π']

# ‚úÖ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
model = RandomForestClassifier(n_estimators=200, random_state=42)
model.fit(X_train, y_train)
accuracy = model.score(X_test, y_test)
print(f"‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞. –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å: {accuracy:.1%}")

# ‚úÖ –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
try:
    n_new = int(input("\n–°–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å? "))
    new_clients = []

    for i in range(n_new):
        print(f"\nüë§ –ö–ª–∏–µ–Ω—Ç {i+1}")
        vozrast = int(input("–í–æ–∑—Ä–∞—Å—Ç: "))
        pokupki = int(input("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫: "))
        sredniy_chek = float(input("–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ): "))
        akcii = int(input("–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –∞–∫—Ü–∏—è—Ö? (1 ‚Äî –¥–∞, 0 ‚Äî –Ω–µ—Ç): "))
        otsenka = float(input("–û—Ü–µ–Ω–∫–∞ (1-5): "))

        new_clients.append([vozrast, pokupki, sredniy_chek, akcii, otsenka])

    new_df = pd.DataFrame({
        '–í–æ–∑—Ä–∞—Å—Ç': [c[0] for c in new_clients],
        '–ü–æ–∫—É–ø–∫–∏': [c[1] for c in new_clients],
        '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)': [c[2] for c in new_clients],
        '–ê–∫—Ü–∏–∏': [c[3] for c in new_clients],
        '–û—Ü–µ–Ω–∫–∞': [c[4] for c in new_clients],
        'ID': [i+1 for i in range(n_new)]
    })

    probs = model.predict_proba(new_df[['–í–æ–∑—Ä–∞—Å—Ç', '–ü–æ–∫—É–ø–∫–∏', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)', '–ê–∫—Ü–∏–∏', '–û—Ü–µ–Ω–∫–∞']])[:, 1]
    statuses = ["–õ–æ—è–ª—å–Ω—ã–π" if p >= 0.5 else "–í –∑–æ–Ω–µ —Ä–∏—Å–∫–∞" for p in probs]

    results = pd.DataFrame({
        'ID': new_df['ID'],
        '–í–æ–∑—Ä–∞—Å—Ç': new_df['–í–æ–∑—Ä–∞—Å—Ç'],
        '–ü–æ–∫—É–ø–∫–∏': new_df['–ü–æ–∫—É–ø–∫–∏'],
        '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)': new_df['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (‚ÇΩ)'],
        '–ê–∫—Ü–∏–∏': new_df['–ê–∫—Ü–∏–∏'],
        '–û—Ü–µ–Ω–∫–∞': new_df['–û—Ü–µ–Ω–∫–∞'],
        '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏': [f"{p:.1%}" for p in probs],
        '–°—Ç–∞—Ç—É—Å': statuses
    })

    print("\n" + "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê".center(80))
    print("=" * 80)
    print(results.to_string(index=False))
    print("=" * 80)

    create_visualizations(results, n_new)
    print_recommendations(results, n_new)

except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

print("\n" + "=" * 60)
print("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")
print("=" * 60)
